{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "EasyScale AI Agent Implementation Blueprint",
  "description": "Generated by the conversation analyzer to automate AI agent setup for aesthetic clinics. Consumed by n8n for zero-touch onboarding.",
  "type": "object",
  "required": [
    "metadata",
    "agent_identity",
    "knowledge_base_mapping",
    "conversational_flow",
    "shadow_dna_profile",
    "outcome_summary",
    "financial_kpis"
  ],
  "properties": {

    "metadata": {
      "type": "object",
      "description": "Blueprint generation metadata ‚Äî used for versioning and traceability in n8n.",
      "required": ["client_slug", "client_name", "generated_at", "analyzer_version", "conversation_count"],
      "properties": {
        "client_slug":        { "type": "string", "examples": ["sgen"] },
        "client_name":        { "type": "string", "examples": ["Sorriso Da Gente"] },
        "generated_at":       { "type": "string", "format": "date-time" },
        "analyzer_version":   { "type": "string", "examples": ["0.1.0"] },
        "conversation_count": { "type": "integer", "minimum": 1 },
        "rag_efficiency_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "% of patient questions answerable from the detected knowledge base. Formula: (resolved_queries / total_unique_queries) * 100"
        }
      }
    },

    "agent_identity": {
      "type": "object",
      "description": "Core identity and communication style for the AI agent system prompt.",
      "required": ["name", "personality_traits", "forbidden_terms"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Suggested agent name, typically incorporating the clinic name.",
          "examples": ["Assistente Virtual Sorriso Da Gente"]
        },
        "personality_traits": {
          "type": "array",
          "description": "Traits and communication styles detected from clinic conversations. Used directly in system prompt.",
          "items": { "type": "string" },
          "examples": [["Emp√°tico", "Eficiente", "Usa emojis de gratid√£o", "Responde de forma concisa"]]
        },
        "forbidden_terms": {
          "type": "array",
          "description": "Terms/phrases to avoid ‚Äî detected from poor-outcome or flagged conversations.",
          "items": { "type": "string" },
          "examples": [["N√£o sabemos informar", "Ligue mais tarde", "N√£o √© comigo"]]
        }
      }
    },

    "knowledge_base_mapping": {
      "type": "object",
      "description": "Key entities and gaps extracted from conversations ‚Äî seeds the agent's RAG knowledge base.",
      "required": ["confirmed_procedures", "detected_insurances", "unresolved_queries"],
      "properties": {
        "confirmed_procedures": {
          "type": "array",
          "description": "Procedures frequently discussed and confirmed by the clinic.",
          "items": { "type": "string" },
          "examples": [["Invisalign", "Clareamento dental", "Implante dent√°rio"]]
        },
        "detected_insurances": {
          "type": "array",
          "description": "Health insurance providers mentioned in conversations.",
          "items": { "type": "string" },
          "examples": [["Amil", "Bradesco Sa√∫de", "SulAm√©rica"]]
        },
        "unresolved_queries": {
          "type": "array",
          "description": "Questions/topics that repeatedly went unanswered or caused handoffs ‚Äî highest-priority training gaps.",
          "items": { "type": "string" },
          "examples": [["Pre√ßo exato da pr√≥tese total", "Hor√°rio de atendimento aos s√°bados", "Parcelamento sem juros"]]
        },
        "payment_methods": {
          "type": "array",
          "description": "Payment methods mentioned (detected from conversations).",
          "items": { "type": "string" },
          "examples": [["Cart√£o de cr√©dito", "PIX", "Parcelamento em at√© 12x"]]
        }
      }
    },

    "conversational_flow": {
      "type": "object",
      "description": "Rules and patterns for the agent's conversational flow, derived from real clinic behavior.",
      "required": ["greeting_style", "closing_style", "handoff_trigger"],
      "properties": {
        "greeting_style": {
          "type": "object",
          "description": "How the clinic typically opens a conversation.",
          "required": ["tone", "example"],
          "properties": {
            "tone": {
              "type": "string",
              "enum": ["formal", "informal", "neutro"],
              "description": "Overall tone of the greeting."
            },
            "example": {
              "type": "string",
              "description": "A real or representative greeting extracted from conversations ‚Äî used as few-shot in system prompt.",
              "examples": ["Ol√°! üòä Tudo bem? Sou a assistente virtual da Sorriso Da Gente. Como posso te ajudar hoje?"]
            }
          }
        },
        "closing_style": {
          "type": "object",
          "description": "How the clinic typically closes or wraps up a conversation.",
          "required": ["tone", "example"],
          "properties": {
            "tone": {
              "type": "string",
              "enum": ["formal", "informal", "neutro"]
            },
            "example": {
              "type": "string",
              "examples": ["Qualquer d√∫vida √© s√≥ chamar! Te esperamos na cl√≠nica üôè"]
            }
          }
        },
        "handoff_trigger": {
          "type": "object",
          "description": "Conditions that should escalate the conversation to a human agent.",
          "required": ["keywords", "situations"],
          "properties": {
            "keywords": {
              "type": "array",
              "description": "Exact or near-exact phrases that trigger handoff.",
              "items": { "type": "string" },
              "examples": [["quero falar com um humano", "falar com o financeiro", "preciso de um atendente"]]
            },
            "situations": {
              "type": "array",
              "description": "Contextual situations (detected by LLM) that should trigger handoff.",
              "items": { "type": "string" },
              "examples": [["Reclama√ß√£o formal", "Emerg√™ncia odontol√≥gica", "Negocia√ß√£o de desconto acima de 20%"]]
            }
          }
        }
      }
    },

    "shadow_dna_profile": {
      "type": "object",
      "description": "Deep behavioral fingerprint of the clinic's communication style. Used to make the AI agent indistinguishable from the human team.",
      "required": [
        "tone_classification",
        "average_response_length_tokens",
        "emoji_frequency",
        "sentiment_score_distribution",
        "response_time_metrics",
        "common_objections",
        "local_entities"
      ],
      "properties": {
        "tone_classification": {
          "type": "string",
          "enum": ["Formal", "Informal", "Emp√°tico", "Direto", "Misto"],
          "description": "Overall dominant tone of the clinic's communication."
        },
        "average_response_length_tokens": {
          "type": "number",
          "minimum": 0,
          "description": "Average token count of clinic responses. Used to calibrate agent response length."
        },
        "emoji_frequency": {
          "type": "object",
          "description": "Per-emoji usage frequency (ratio of messages containing this emoji). e.g. {'üòä': 0.15}",
          "additionalProperties": {
            "type": "number",
            "minimum": 0,
            "maximum": 1
          }
        },
        "sentiment_score_distribution": {
          "type": "object",
          "description": "Distribution of sentiment across clinic responses.",
          "properties": {
            "positive": { "type": "number", "minimum": 0, "maximum": 1 },
            "neutral":  { "type": "number", "minimum": 0, "maximum": 1 },
            "negative": { "type": "number", "minimum": 0, "maximum": 1 }
          }
        },
        "response_time_metrics": {
          "type": "object",
          "description": "Human response time baseline ‚Äî defines the SLA the AI agent should match or beat.",
          "properties": {
            "average_seconds":          { "type": "number", "minimum": 0 },
            "median_seconds":           { "type": "number", "minimum": 0 },
            "sla_adherence_percentage": { "type": "number", "minimum": 0, "maximum": 100 }
          }
        },
        "common_objections": {
          "type": "array",
          "description": "Most frequent patient objections detected. Agent must have scripted responses for each.",
          "items": { "type": "string" },
          "examples": [["Pre√ßo muito alto", "N√£o tenho tempo", "Vou pensar e te aviso"]]
        },
        "local_entities": {
          "type": "object",
          "description": "Clinic-specific entities extracted from conversations ‚Äî critical for accurate RAG responses.",
          "properties": {
            "neighborhoods": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Neighborhoods or areas mentioned (for location/directions questions)."
            },
            "procedures": {
              "type": "array",
              "items": { "type": "string" },
              "description": "All procedures mentioned, including informal names."
            },
            "payment_conditions": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Specific payment terms mentioned (e.g., '12x sem juros no cart√£o')."
            }
          }
        }
      }
    },

    "outcome_summary": {
      "type": "object",
      "description": "Distribution of conversation outcomes ‚Äî the core conversion intelligence.",
      "required": ["agendado", "ghosting", "objecao_ativa", "pendente", "outro", "conversion_rate"],
      "properties": {
        "agendado":       { "type": "integer", "minimum": 0, "description": "Conversations that resulted in a confirmed appointment." },
        "ghosting":       { "type": "integer", "minimum": 0, "description": "Patient stopped responding abruptly." },
        "objecao_ativa":  { "type": "integer", "minimum": 0, "description": "Patient expressed a clear objection (price, time, etc.)." },
        "pendente":       { "type": "integer", "minimum": 0, "description": "Conversation in progress, no clear outcome yet." },
        "outro":          { "type": "integer", "minimum": 0, "description": "Uncategorized outcomes." },
        "conversion_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "agendado / total conversations."
        }
      }
    },

    "financial_kpis": {
      "type": "object",
      "description": "Financial impact analysis ‚Äî the headline of the executive report.",
      "required": ["leads_lost", "opportunity_loss_value", "ticket_medio_source"],
      "properties": {
        "ticket_medio": {
          "type": "number",
          "minimum": 0,
          "description": "Average ticket value in BRL. Provided by user or estimated by LLM."
        },
        "ticket_medio_source": {
          "type": "string",
          "enum": ["user_input", "llm_estimate"],
          "description": "Transparency flag ‚Äî was the ticket medio provided by the client or estimated?"
        },
        "leads_lost": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of conversations with outcome ghosting or objecao_ativa."
        },
        "opportunity_loss_value": {
          "type": "number",
          "minimum": 0,
          "description": "leads_lost √ó ticket_medio. Headline figure for executive report."
        },
        "potential_recovery_value": {
          "type": "number",
          "minimum": 0,
          "description": "Estimated recoverable revenue if AI agent converts 30% of lost leads (conservative scenario)."
        }
      }
    }

  }
}
